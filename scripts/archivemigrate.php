#!/usr/bin/php -q
<?
/**
 * TODO Log
 **
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200506
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200507
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200508
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200509
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200510
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200511
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200512
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200601
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200602
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200603
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200604
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200605
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200606
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200607
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200608
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200609
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200610
[DONE] ./archivemigrate.php -h backup -d archives -t commentarchive200611
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200509
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200510
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200511
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200512
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200601
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200602
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200603
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200604
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200605
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200606
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200607
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200608
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200609
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200610
[DONE] ./archivemigrate.php -h backup -d archives -t msgarchive200611

// New Old Archives
[DONE] ./archivemigrate.php -h backup -d archive1 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive1 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive2 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive2 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive3 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive3 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive4 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive4 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive5 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive5 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive6 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive6 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive7 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive7 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive8 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive8 -t usercommentsarchive

[RUNNING] ./archivemigrate.php -h backup -d archive9 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive9 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive10 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive10 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive11 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive11 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive12 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive12 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive13 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive13 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive14 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive14 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive15 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive15 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive16 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive16 -t usercommentsarchive

[DONE] ./archivemigrate.php -h backup -d archive17 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive17 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive18 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive18 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive19 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive19 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive20 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive20 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive21 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive21 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive22 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive22 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive23 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive23 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive24 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive24 -t usercommentsarchive
[DONE] ./archivemigrate.php -h backup -d archive25 -t msgarchive
[DONE] ./archivemigrate.php -h backup -d archive25 -t usercommentsarchive

[RUNNING] ./archivemigrate.php -h backup -d archive26 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive26 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive27 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive27 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive28 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive28 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive29 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive29 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive30 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive30 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive31 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive31 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive32 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive32 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive33 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive33 -t usercommentsarchive
[RUNNING] ./archivemigrate.php -h backup -d archive34 -t msgarchive
[RUNNING] ./archivemigrate.php -h backup -d archive34 -t usercommentsarchive
 **/

$forceserver=true;
$errorLogging=true;
$_SERVER['SERVER_NAME'] = $_SERVER['HTTP_HOST'] = ".www.nexopia.com";

chdir("/home/nexopia/public_html");
require_once("include/general.lib.php");


define('ARCHIVE_MIGRATE_BADTABLE', -1);		// Table not found.
define('ARCHIVE_MIGRATE_INVALID', 0);		// Auto-detect failed.
define('ARCHIVE_MIGRATE_OLD_COMMENTS', 1);	// userid, id, from, time, msg
define('ARCHIVE_MIGRATE_OLD_MESSAGES', 2);	// userid, id, from, time, subject, msg
define('ARCHIVE_MIGRATE_NEW_COMMENTS', 3);	// userid, id, authorid, time, msg
define('ARCHIVE_MIGRATE_NEW_MESSAGES', 4);	// userid, id, to, toname, from, fromname, date, subject, msg


// the schema is the SELECT clause that returns userid, id, type, time, touserid, subject, msg.
$schemas = Array(
	ARCHIVE_MIGRATE_OLD_COMMENTS => 
		'`from` AS `userid`, `id`, ' . ARCHIVE_COMMENT . ' AS `type`, `time`, `userid` AS `touserid`, `msg`',
	ARCHIVE_MIGRATE_OLD_MESSAGES => 
		'`from` AS `userid`, `id`, ' . ARCHIVE_MESSAGE . ' AS `type`, `time`, `userid` AS `touserid`, `subject`, `msg`',
	ARCHIVE_MIGRATE_NEW_COMMENTS => 
		'`authorid` AS `userid`, `id`, ' . ARCHIVE_COMMENT . ' AS `type`, `time`, `userid` AS `touserid`, `msg`',
	ARCHIVE_MIGRATE_NEW_MESSAGES => 
		'`from` AS `userid`, `id`, ' . ARCHIVE_MESSAGE . ' AS `type`, `date` AS `time`, `to` AS `touserid`, `subject`, `msg`',
);

$schema_names = Array('Auto-Detect Failure', 'Old Comments', 'Old Messages', 'New Comments', 'New Messages');

//////////////////////////////////////////////////////////////////////////////
$verbose = 2;		// verbose level? 0 - nothing, 1 - only final stats, 2 - little output, 3 - lots of output
$completed = 0;		// Row count of completed

// These are for the source server
$dbuser = 'root';
$dbpass = 'pRlUvi$t';
$dbhost = null;
$dbdatabase = null;
$dbtable = null;

//////////////////////////////////////////////////////////////////////////////

$name = array_shift($argv);
while(1) {
	if(!count($argv))
		break;

	switch (array_shift($argv)) {
		case '-q':
			$verbose--;
			break;

		case '-v':
			$verbose++;
			break;
		
		case '-h':
			$dbhost = array_shift($argv);
			break;

		case '-d':
			$dbdatabase = array_shift($argv);
			break;

		case '-t':
			$dbtable = array_shift($argv);
			break;

		case '--help':
			die("$name [-q|-v] -h hostname -d database -t table\n");

		default:
			die("Unknown Argument $arg\n");
	}
}

if (!$dbtable || !$dbdatabase || !$dbhost)
	die("Must specify hostname, database and table.  See --help.\n");



//////////////////////////////////////////////////////////////////////////////
$rows_moved = 0;
$timemoving = 0;
$timesleeping = 0;
//////////////////////////////////////////////////////////////////////////////


$source_db = mysql_connect($dbhost, $dbuser, $dbpass)
	or die('Unable to connect to source database: ' . mysql_error());
mysql_select_db($dbdatabase, $source_db)
	or die('Unable to select source database: ' . mysql_error($source_db));

myprint("Detecting table information...\n", 2);
$table_info = get_table_info($source_db, $dbtable);

if ($table_info['type'] == ARCHIVE_MIGRATE_BADTABLE)
	die("Invalid table $dbtable.\n");

if ($table_info['type'] == ARCHIVE_MIGRATE_INVALID)
	die("Unable to auto-detect the format of $dbtable.\n");

myprint("-----------------------------------------------------\n", 2);
myprint(" Table Name:      $dbtable\n", 2);
myprint(" Table Type:      " . $schema_names[$table_info['type']] . "\n", 2);
myprint(" Number of rows:  " . $table_info['count'] . "\n", 2);
myprint("-----------------------------------------------------\n", 2);

$query = "SELECT " . $schemas[$table_info['type']] . " FROM $dbtable";
myprint(" Executing unbuffer query:\n$query\n", 3);

$res = mysql_unbuffered_query($query, $source_db);

if (!$res)
	die("Query failed: " . mysql_error($source_db) . "\n");

$starttime = time();
$last = $starttime;
while ($row = mysql_fetch_array($res, MYSQL_ASSOC)) {

	// update the time every 100 queries
	if ($completed % 100 == 0)
		$now = time();
	else
		$now = $last;

	if ($now >= $last + 1) {
		$t = $now - $starttime;

		// assumes we'll ALWAYS do more then 100 qps
		$rps = $completed / $t;
		$complete_pct = 100 * $completed / $table_info['count'];
		$remaining = $table_info['count'] - $completed;
		$eta = $remaining / $rps;
		myprint(
			sprintf("%.2f rows/sec, %i remaining, %.2f%% complete, %.2f seconds till complete.\n",
				$rps, $remaining, $complete_pct, $eta
			), 2);
	}

////////////////////////
// INSERT PROPER ARCHIVE CODE HERE
////////////////////////
//	myprint("userid=$row[userid], id=$row[id], type=$row[type], time=$row[time], touserid=$row[touserid], subject=$row[subject], msg=[hidden]\n", 5);
	// how do I handle failure?  Currently it just croaks.
	if (!isset($row['subject']))
		$row['subject'] = '';

	$archive->insert($row['userid'], $row['id'], $row['type'], 0, $row['time'], 0, $row['touserid'], 0, $row['subject'], $row['msg'], true);

	$completed++;
	$last = $now;
}

function get_table_info($dbh, $table) {
	$res = mysql_query("DESCRIBE $table", $dbh);
	if (!$res)
		return Array('type' => ARCHIVE_MIGRATE_BADTABLE);

	$rv = Array();
	$columns = Array();

	while ($row = mysql_fetch_array($res, MYSQL_ASSOC))
		$columns[] = $row['Field'];

	mysql_free_result($res);

	$joined = strtolower(join(' ', $columns));
	
	switch ($joined) {
		case 'userid id from time msg':
			$rv['type'] = ARCHIVE_MIGRATE_OLD_COMMENTS;
			break;
		case 'userid id from time subject msg':
			$rv['type'] = ARCHIVE_MIGRATE_OLD_MESSAGES;
			break;
		case 'userid id authorid time msg':
			$rv['type'] = ARCHIVE_MIGRATE_NEW_COMMENTS;
			break;
		case 'userid id to toname from fromname date subject msg':
			$rv['type'] = ARCHIVE_MIGRATE_NEW_MESSAGES;
			break;
		default:
			$rv['type'] = ARCHIVE_MIGRATE_INVALID;
			break;
	}

	if ($rv['type'] != ARCHIVE_MIGRATE_INVALID) {
		$res = mysql_query('SELECT COUNT(*) AS c FROM ' . $table, $dbh);
		if (!$res) {
			$rv['type'] = ARCHIVE_MIGRATE_INVALID;
		} else {
			$line = mysql_fetch_array($res, MYSQL_ASSOC);
			mysql_free_result($res);

			$rv['count'] = $line['c'];
		}
	}

	return $rv;
}


function myprint($str, $level){
	global $verbose;

	if(($level === true) || ($level !== false && $level <= $verbose))
		echo $str;
}

